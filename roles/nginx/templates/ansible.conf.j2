# nginx template generated by Ansible, don't bother editing
{% for name, server in nginx_servers.iteritems() %}
server {
    server_name     {{ name }};
    {% if name in nginx_ssl %}
    ssl_certificate     /etc/nginx/certs/{{ nginx_ssl[name] }}/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/{{ nginx_ssl[name] }}/privkey.pem;{% endif %}

    {% for extra in server.get('extra', []) %}
    {{ extra }};{% endfor %}
    {% for include in server.get('includes', []) %}
    include         {{ include }};{% endfor %} 
    {% for address in server.get('allow', []) %}
    allow           {{ address }};{% endfor %}
    {% if 'redirect' in server %}
    listen *:80;
    listen *:443 ssl;
    location / {
        return 301 $scheme://{{ server.get('redirect') }}$request_uri;
    }
    {% else %}{% for l in server.get('locations', []) %}
    location {{ l['path'] }} { 
    {% for rule in l['rules'] %}
        {{ rule }}{% if rule[-1] not in [';', '}'] %};{% endif %}
    {% endfor %}
    }
    {% endfor %}{% endif %}
}
{% endfor %}
